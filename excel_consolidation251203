import pandas as pd
import glob
import os
import tkinter as tk
from tkinter import filedialog, messagebox

def select_folder():
    folder_path = filedialog.askdirectory()
    folder_var.set(folder_path)

def select_output():
    file_path = filedialog.asksaveasfilename(
        defaultextension=".xlsx",
        filetypes=[("Excel 文件", "*.xlsx")]
    )
    output_var.set(file_path)

def merge_excels():
    input_folder = folder_var.get()
    output_file = output_var.get()

    if not input_folder:
        messagebox.showerror("错误", "请选择 Excel 文件夹！")
        return

    if not output_file:
        messagebox.showerror("错误", "请选择输出文件！")
        return

    files = glob.glob(os.path.join(input_folder, "*.xlsx"))
    if not files:
        messagebox.showerror("错误", "文件夹中没有 .xlsx 文件！")
        return

    try:
        df_list = []
        all_columns = set()

        # ⭐ 读取第一个文件作为列顺序基准
        first_df = pd.read_excel(files[0])
        first_columns = list(first_df.columns)
        all_columns.update(first_columns)

        # ⭐ 处理所有文件
        for f in files:
            df = pd.read_excel(f)

            # 增加来源文件列
            df["来源文件"] = os.path.basename(f)

            df_list.append(df)

            # 收集所有出现过的列
            all_columns.update(df.columns)

        # ⭐ 最终列顺序 = 第一个文件列 + 其他新增列（按字母序）
        all_columns = list(all_columns)
        all_columns_sorted = first_columns + sorted([c for c in all_columns if c not in first_columns])

        # ⭐ 合并并按照列名对齐
        final = pd.concat(df_list, ignore_index=True, sort=False)

        # ⭐ 重新按照最终列顺序排列
        final = final.reindex(columns=all_columns_sorted)

        final.to_excel(output_file, index=False)

        messagebox.showinfo("成功", f"合并完成！\n已导出：\n{output_file}")
    except Exception as e:
        messagebox.showerror("合并失败", str(e))

# ---- GUI ----
root = tk.Tk()
root.title("Excel 标题列合并工具（同名列对齐 + 来源文件）")
root.geometry("480x240")

folder_var = tk.StringVar()
output_var = tk.StringVar()

tk.Label(root, text="选择 Excel 文件夹：").pack(anchor="w", padx=10, pady=5)
tk.Entry(root, textvariable=folder_var, width=50).pack(anchor="w", padx=10)
tk.Button(root, text="浏览…", command=select_folder).pack(anchor="w", padx=10, pady=5)

tk.Label(root, text="选择导出文件：").pack(anchor="w", padx=10)
tk.Entry(root, textvariable=output_var, width=50).pack(anchor="w", padx=10)
tk.Button(root, text="保存为…", command=select_output).pack(anchor="w", padx=10, pady=5)

tk.Button(root, text="开始合并", command=merge_excels, height=2, width=20).pack(pady=15)

root.mainloop()
